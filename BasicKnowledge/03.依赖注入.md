# FastAPI ä¾èµ–æ³¨å…¥å®Œå…¨æŒ‡å—

## è¯´æ˜

ç”±äºè¿™æ˜¯åœ¨åˆ«ç¯å¢ƒåˆ›å»ºçš„æ–‡ä»¶ï¼Œå¯¼è‡´äº†åŸºæœ¬çš„è™šæ‹Ÿç¯å¢ƒæ˜¯æ²¡æœ‰é…ç½®çš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å®‰è£…Miniconda3

è€Œæ­¤æ—¶è™½ç„¶é…ç½®äº†ç›¸åº”çš„è§£é‡Šå™¨ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰é…ç½®uvicorn ç„¶åç›´æ¥è¿è¡Œæ˜¯è·‘ä¸èµ·æ¥çš„ï¼Œå› æ­¤ï¼Œå¦‚æœéš¾å¾—å®‰è£…Miniconda3  åªæƒ³åœ¨æœ¬åœ°å­¦ä¹ çš„è¯ï¼Œå°±å…ˆå»å®‰è£…uvicorn

```bash
pip install fastapi uvicorn
```

ç„¶åå†è¿è¡Œå°±è¡Œäº†

```bash
uvicorn depends:app --reload
```

![image-20251222143514850](03.ä¾èµ–æ³¨å…¥.assets/image-20251222143514850.png)

## ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥?

ä¾èµ–æ³¨å…¥(Dependency Injection, DI)æ˜¯ä¸€ç§**è®¾è®¡æ¨¡å¼**,ç®€å•æ¥è¯´å°±æ˜¯:å½“ä¸€ä¸ªå‡½æ•°éœ€è¦ä½¿ç”¨æŸäº›èµ„æºæˆ–æ•°æ®æ—¶,ä¸æ˜¯åœ¨å‡½æ•°å†…éƒ¨ç›´æ¥åˆ›å»º,è€Œæ˜¯ç”±å¤–éƒ¨"æ³¨å…¥"è¿›æ¥ã€‚

**ä¸¾ä¸ªç”Ÿæ´»ä¾‹å­:**

- âŒ ä¸å¥½çš„æ–¹å¼:ä½ æ¯æ¬¡åšé¥­éƒ½è¦è‡ªå·±å»èœå¸‚åœºä¹°èœã€å›æ¥æ´—èœ
- âœ… å¥½çš„æ–¹å¼:æœ‰äººå¸®ä½ æŠŠæ´—å¥½çš„èœç›´æ¥é€åˆ°å¨æˆ¿,ä½ åªéœ€è¦åšé¥­

åœ¨ FastAPI ä¸­,ä¾èµ–æ³¨å…¥å¸®åŠ©æˆ‘ä»¬:

- å¤ç”¨ä»£ç (æ¯”å¦‚æ•°æ®åº“è¿æ¥ã€ç”¨æˆ·è®¤è¯)
- ä»£ç æ›´æ¸…æ™°æ˜“è¯»
- æ–¹ä¾¿æµ‹è¯•å’Œç»´æŠ¤

------

## åŸºç¡€æ¦‚å¿µ:ç¬¬ä¸€ä¸ªä¾èµ–æ³¨å…¥

### æœ€ç®€å•çš„ä¾‹å­

```python
from fastapi import FastAPI, Depends

app = FastAPI()

# è¿™æ˜¯ä¸€ä¸ªä¾èµ–å‡½æ•°
def get_current_user():
    return {"username": "å¼ ä¸‰", "id": 1}

# åœ¨è·¯å¾„æ“ä½œä¸­ä½¿ç”¨ä¾èµ–
@app.get("/user")
def read_user(user: dict = Depends(get_current_user)):
    return {"message": f"ä½ å¥½, {user['username']}"}
```

**è§£é‡Š:**

1. `get_current_user()` æ˜¯ä¸€ä¸ªæ™®é€šçš„ Python å‡½æ•°,æˆ‘ä»¬ç§°å®ƒä¸º"ä¾èµ–å‡½æ•°"
2. `Depends(get_current_user)` å‘Šè¯‰ FastAPI:"è¯·å…ˆæ‰§è¡Œ `get_current_user`,ç„¶åæŠŠç»“æœä¼ ç»™ `user` å‚æ•°"
3. å½“è®¿é—® `/user` æ—¶,FastAPI ä¼šè‡ªåŠ¨è°ƒç”¨ `get_current_user()`,ç„¶åæŠŠè¿”å›å€¼ä¼ é€’ç»™ `read_user` å‡½æ•°

![image-20251222143639489](03.ä¾èµ–æ³¨å…¥.assets/image-20251222143639489.png)

------

## å¸¦å‚æ•°çš„ä¾èµ–

ä¾èµ–å‡½æ•°ä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„å‚æ•°:

```python
from fastapi import FastAPI, Depends, Query

app = FastAPI()

# ä¾èµ–å‡½æ•°å¯ä»¥æ¥æ”¶å‚æ•°
def pagination(page: int = Query(1, ge=1), size: int = Query(10, ge=1, le=100)):
    skip = (page - 1) * size
    return {"skip": skip, "limit": size}

@app.get("/items")
def get_items(pagination_params: dict = Depends(pagination)):
    # æ¨¡æ‹Ÿä»æ•°æ®åº“è·å–æ•°æ®
    return {
        "page": pagination_params,
        "data": ["å•†å“1", "å•†å“2", "å•†å“3"]
    }
```

**è®¿é—®ç¤ºä¾‹:**

- `GET /items?page=2&size=20`
- FastAPI ä¼šè‡ªåŠ¨ä»æŸ¥è¯¢å‚æ•°ä¸­æå– `page` å’Œ `size`,ä¼ ç»™ `pagination` å‡½æ•°

![image-20251222144426892](03.ä¾èµ–æ³¨å…¥.assets/image-20251222144426892.png)

------

## åµŒå¥—ä¾èµ–:ä¾èµ–ä¸­è¿˜æœ‰ä¾èµ–

ä¾èµ–å¯ä»¥ç›¸äº’ä¾èµ–,å½¢æˆé“¾å¼ç»“æ„:

```python
from fastapi import FastAPI, Depends, Header, HTTPException

app = FastAPI()

# ç¬¬ä¸€å±‚ä¾èµ–:è·å–token
def get_token(authorization: str = Header(...)):
    if not authorization.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="æ— æ•ˆçš„è®¤è¯æ ¼å¼")
    return authorization[7:]  # å»æ‰ "Bearer " å‰ç¼€

# ç¬¬äºŒå±‚ä¾èµ–:éªŒè¯ç”¨æˆ·(ä¾èµ–äº get_token)
def get_current_user(token: str = Depends(get_token)):
    # æ¨¡æ‹ŸéªŒè¯token
    if token != "secret123":
        raise HTTPException(status_code=401, detail="æ— æ•ˆçš„token")
    return {"username": "æå››", "id": 2}

# ç¬¬ä¸‰å±‚:æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜(ä¾èµ–äº get_current_user)
def get_admin_user(user: dict = Depends(get_current_user)):
    if user["id"] != 2:  # å‡è®¾åªæœ‰id=2çš„æ˜¯ç®¡ç†å‘˜
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    return user

# åœ¨è·¯å¾„æ“ä½œä¸­ä½¿ç”¨
@app.get("/admin/dashboard")
def admin_dashboard(admin: dict = Depends(get_admin_user)):
    return {"message": f"æ¬¢è¿ç®¡ç†å‘˜ {admin['username']}"}
```

**æ‰§è¡Œæµç¨‹:**

1. FastAPI å…ˆè°ƒç”¨ `get_token()`,ä»è¯·æ±‚å¤´è·å– token
2. ç„¶åè°ƒç”¨ `get_current_user(token)`,éªŒè¯ç”¨æˆ·èº«ä»½
3. æœ€åè°ƒç”¨ `get_admin_user(user)`,æ£€æŸ¥ç®¡ç†å‘˜æƒé™
4. å¦‚æœå…¨éƒ¨é€šè¿‡,æ‰æ‰§è¡Œ `admin_dashboard()`

------

## ä½¿ç”¨ç±»ä½œä¸ºä¾èµ–

é™¤äº†å‡½æ•°,æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ç±»ä½œä¸ºä¾èµ–:

```python
from fastapi import FastAPI, Depends, Query

app = FastAPI()

# ç±»ä¾èµ–
class CommonQueryParams:
    def __init__(
        self, 
        q: str = Query(None, description="æœç´¢å…³é”®è¯"),
        skip: int = Query(0, ge=0),
        limit: int = Query(10, ge=1, le=100)
    ):
        self.q = q
        self.skip = skip
        self.limit = limit

@app.get("/search")
def search_items(commons: CommonQueryParams = Depends()):
    response = {
        "query": commons.q,
        "skip": commons.skip,
        "limit": commons.limit
    }
    return response
```

**æ³¨æ„:** `Depends()` ä¸å¸¦å‚æ•°æ—¶,FastAPI ä¼šè‡ªåŠ¨è¯†åˆ«å‚æ•°ç±»å‹(è¿™é‡Œæ˜¯ `CommonQueryParams`)

![image-20251222152232229](03.ä¾èµ–æ³¨å…¥.assets/image-20251222152232229.png)



------

## å®æˆ˜æ¡ˆä¾‹:æ•°æ®åº“è¿æ¥

è¿™æ˜¯ä¾èµ–æ³¨å…¥æœ€å¸¸ç”¨çš„åœºæ™¯ä¹‹ä¸€:

```python
from fastapi import FastAPI, Depends
from typing import Generator

app = FastAPI()

# æ¨¡æ‹Ÿæ•°æ®åº“ç±»
class FakeDatabase:
    def __init__(self):
        self.connection = "æ•°æ®åº“è¿æ¥å·²å»ºç«‹"
    
    def get_user(self, user_id: int):
        return {"id": user_id, "name": f"ç”¨æˆ·{user_id}"}
    
    def close(self):
        print("æ•°æ®åº“è¿æ¥å·²å…³é—­")

# æ•°æ®åº“ä¾èµ–(ä½¿ç”¨ç”Ÿæˆå™¨,è‡ªåŠ¨æ¸…ç†èµ„æº)
def get_db() -> Generator:
    db = FakeDatabase()
    try:
        yield db  # è¿”å›æ•°æ®åº“å®ä¾‹
    finally:
        db.close()  # è¯·æ±‚ç»“æŸåè‡ªåŠ¨æ‰§è¡Œæ¸…ç†

# ä½¿ç”¨æ•°æ®åº“ä¾èµ–
@app.get("/users/{user_id}")
def read_user(user_id: int, db: FakeDatabase = Depends(get_db)):
    user = db.get_user(user_id)
    return user
```

**å·¥ä½œåŸç†:**

1. è¯·æ±‚åˆ°æ¥æ—¶,FastAPI æ‰§è¡Œ `get_db()`,åˆ›å»ºæ•°æ®åº“è¿æ¥
2. `yield db` æŠŠæ•°æ®åº“å®ä¾‹ä¼ ç»™è·¯å¾„æ“ä½œå‡½æ•°
3. è·¯å¾„æ“ä½œå‡½æ•°æ‰§è¡Œå®Œæ¯•å,FastAPI æ‰§è¡Œ `finally` å—ä¸­çš„æ¸…ç†ä»£ç 

------

## å…¨å±€ä¾èµ–:å¯¹æ‰€æœ‰è·¯ç”±ç”Ÿæ•ˆ

å¦‚æœæŸä¸ªä¾èµ–éœ€è¦åº”ç”¨åˆ°æ‰€æœ‰è·¯ç”±,å¯ä»¥åœ¨åˆ›å»º `FastAPI` å®ä¾‹æ—¶æŒ‡å®š:

```python
from fastapi import FastAPI, Depends, HTTPException, Header

# å…¨å±€ä¾èµ–:æ£€æŸ¥APIå¯†é’¥
def verify_api_key(x_api_key: str = Header(...)):
    if x_api_key != "my-secret-key":
        raise HTTPException(status_code=403, detail="æ— æ•ˆçš„APIå¯†é’¥")
    return x_api_key

# å°†ä¾èµ–åº”ç”¨åˆ°æ•´ä¸ªåº”ç”¨
app = FastAPI(dependencies=[Depends(verify_api_key)])

@app.get("/public")
def public_endpoint():
    return {"message": "è¿™ä¸ªæ¥å£ä¹Ÿéœ€è¦APIå¯†é’¥"}

@app.get("/private")
def private_endpoint():
    return {"message": "ç§æœ‰æ•°æ®"}
```

**æ³¨æ„:** æ‰€æœ‰è·¯ç”±éƒ½ä¼šå…ˆæ‰§è¡Œ `verify_api_key` æ£€æŸ¥

------

## è·¯ç”±çº§åˆ«çš„ä¾èµ–

ä¹Ÿå¯ä»¥åªå¯¹æŸäº›è·¯ç”±ç»„åº”ç”¨ä¾èµ–:

```python
from fastapi import FastAPI, APIRouter, Depends

app = FastAPI()

def admin_required():
    # æ¨¡æ‹Ÿç®¡ç†å‘˜æ£€æŸ¥
    return {"role": "admin"}

# åˆ›å»ºè·¯ç”±ç»„,æŒ‡å®šä¾èµ–
admin_router = APIRouter(
    prefix="/admin",
    dependencies=[Depends(admin_required)]  # è¿™ä¸ªè·¯ç”±ç»„ä¸‹çš„æ‰€æœ‰è·¯ç”±éƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
)

@admin_router.get("/users")
def list_users():
    return {"users": ["ç”¨æˆ·1", "ç”¨æˆ·2"]}

@admin_router.delete("/users/{user_id}")
def delete_user(user_id: int):
    return {"message": f"åˆ é™¤ç”¨æˆ· {user_id}"}

app.include_router(admin_router)
```

------

## ä¾èµ–çš„ç¼“å­˜æœºåˆ¶

åœ¨åŒä¸€ä¸ªè¯·æ±‚ä¸­,ç›¸åŒçš„ä¾èµ–é»˜è®¤åªä¼šæ‰§è¡Œä¸€æ¬¡:

```python
from fastapi import FastAPI, Depends

app = FastAPI()

call_count = 0

def expensive_operation():
    global call_count
    call_count += 1
    print(f"æ‰§è¡Œäº† {call_count} æ¬¡")
    return {"result": "expensive data"}

@app.get("/test")
def test_endpoint(
    dep1: dict = Depends(expensive_operation),
    dep2: dict = Depends(expensive_operation)  # ä¸ä¼šé‡å¤æ‰§è¡Œ
):
    return {"dep1": dep1, "dep2": dep2, "call_count": call_count}
```

**å¦‚æœéœ€è¦æ¯æ¬¡éƒ½æ‰§è¡Œ,å¯ä»¥è®¾ç½® `use_cache=False`:**

```python
@app.get("/test-no-cache")
def test_endpoint(
    dep1: dict = Depends(expensive_operation),
    dep2: dict = Depends(expensive_operation, use_cache=False)  # ä¼šæ‰§è¡Œä¸¤æ¬¡
):
    return {"dep1": dep1, "dep2": dep2}
```

------

## å®æˆ˜:å®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

ç»¼åˆè¿ç”¨ä¾èµ–æ³¨å…¥å®ç°ä¸€ä¸ªçœŸå®çš„è®¤è¯ç³»ç»Ÿ:

```python
from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from typing import Optional

app = FastAPI()
security = HTTPBearer()

# æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®åº“
fake_users_db = {
    "token123": {"username": "å¼ ä¸‰", "role": "user"},
    "admintoken": {"username": "ç®¡ç†å‘˜", "role": "admin"}
}

# ä¾èµ–1: è·å–token
def get_token(credentials: HTTPAuthorizationCredentials = Depends(security)):
    return credentials.credentials

# ä¾èµ–2: éªŒè¯ç”¨æˆ·
def get_current_user(token: str = Depends(get_token)):
    user = fake_users_db.get(token)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="è®¤è¯å¤±è´¥"
        )
    return user

# ä¾èµ–3: éªŒè¯ç®¡ç†å‘˜
def get_admin_user(user: dict = Depends(get_current_user)):
    if user["role"] != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="éœ€è¦ç®¡ç†å‘˜æƒé™"
        )
    return user

# å…¬å¼€æ¥å£
@app.get("/")
def public_route():
    return {"message": "è¿™æ˜¯å…¬å¼€æ¥å£"}

# éœ€è¦ç™»å½•çš„æ¥å£
@app.get("/profile")
def get_profile(user: dict = Depends(get_current_user)):
    return {"profile": user}

# éœ€è¦ç®¡ç†å‘˜æƒé™çš„æ¥å£
@app.delete("/users/{user_id}")
def delete_user(user_id: int, admin: dict = Depends(get_admin_user)):
    return {"message": f"ç®¡ç†å‘˜ {admin['username']} åˆ é™¤äº†ç”¨æˆ· {user_id}"}
```

**æµ‹è¯•æ–¹æ³•:**

```bash
# éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ : Authorization: Bearer token123
# æˆ–ä½¿ç”¨ Swagger UI (è®¿é—® http://localhost:8000/docs)
```

------

## å¸¸è§åº”ç”¨åœºæ™¯æ€»ç»“

| åœºæ™¯       | è¯´æ˜                     | ç¤ºä¾‹                                   |
| ---------- | ------------------------ | -------------------------------------- |
| æ•°æ®åº“è¿æ¥ | ä¸ºæ¯ä¸ªè¯·æ±‚æä¾›æ•°æ®åº“ä¼šè¯ | `db: Session = Depends(get_db)`        |
| ç”¨æˆ·è®¤è¯   | éªŒè¯ç”¨æˆ·èº«ä»½             | `user = Depends(get_current_user)`     |
| åˆ†é¡µå‚æ•°   | å¤ç”¨åˆ†é¡µé€»è¾‘             | `pagination = Depends(get_pagination)` |
| é…ç½®æ³¨å…¥   | æ³¨å…¥åº”ç”¨é…ç½®             | `config = Depends(get_settings)`       |
| æƒé™æ£€æŸ¥   | éªŒè¯ç”¨æˆ·æƒé™             | `admin = Depends(require_admin)`       |
| æ—¥å¿—è®°å½•   | è‡ªåŠ¨è®°å½•è¯·æ±‚æ—¥å¿—         | `logger = Depends(get_logger)`         |

------

## æœ€ä½³å®è·µå»ºè®®

1. **ä¿æŒä¾èµ–å‡½æ•°ç®€å•**: æ¯ä¸ªä¾èµ–å‡½æ•°åªåšä¸€ä»¶äº‹
2. **ä½¿ç”¨ç±»å‹æ³¨è§£**: å¸®åŠ© IDE æä¾›ä»£ç è¡¥å…¨
3. **åˆç†ä½¿ç”¨åµŒå¥—**: ä¸è¦åµŒå¥—å¤ªæ·±,ä¸€èˆ¬ 2-3 å±‚å°±å¤Ÿäº†
4. **æ³¨æ„æ€§èƒ½**: è€—æ—¶æ“ä½œè€ƒè™‘ä½¿ç”¨ç¼“å­˜
5. **é”™è¯¯å¤„ç†**: åœ¨ä¾èµ–ä¸­æŠ›å‡º `HTTPException` æ¥å¤„ç†é”™è¯¯

------

## å­¦ä¹ è·¯å¾„å»ºè®®

1. âœ… å…ˆæŒæ¡ç®€å•çš„å‡½æ•°ä¾èµ–
2. âœ… å­¦ä¹ å¸¦å‚æ•°çš„ä¾èµ–
3. âœ… ç†è§£åµŒå¥—ä¾èµ–çš„æ‰§è¡Œé¡ºåº
4. âœ… å®è·µæ•°æ®åº“è¿æ¥ç­‰çœŸå®åœºæ™¯
5. âœ… æ„å»ºå®Œæ•´çš„è®¤è¯æˆæƒç³»ç»Ÿ

**ç»§ç»­å­¦ä¹ èµ„æº:**

- FastAPI å®˜æ–¹æ–‡æ¡£: https://fastapi.tiangolo.com/zh/
- ç»ƒä¹ é¡¹ç›®: å°è¯•æ„å»ºä¸€ä¸ªå®Œæ•´çš„ TODO API,ä½¿ç”¨ä¾èµ–æ³¨å…¥ç®¡ç†æ•°æ®åº“å’Œç”¨æˆ·è®¤è¯

------

## ç»ƒä¹ é¢˜

è‡ªå·±åŠ¨æ‰‹è¯•è¯•:

1. åˆ›å»ºä¸€ä¸ªä¾èµ–å‡½æ•°,ä»è¯·æ±‚å¤´ä¸­è·å– `User-Agent`
2. å®ç°ä¸€ä¸ªé€Ÿç‡é™åˆ¶ä¾èµ–,é™åˆ¶æ¯ä¸ª IP æ¯åˆ†é’Ÿåªèƒ½è¯·æ±‚ 10 æ¬¡
3. æ„å»ºä¸€ä¸ªå¤šç§Ÿæˆ·ç³»ç»Ÿ,ä½¿ç”¨ä¾èµ–æ³¨å…¥è¯†åˆ«ä¸åŒç§Ÿæˆ·

åŠ æ²¹!ä¾èµ–æ³¨å…¥æ˜¯ FastAPI çš„æ ¸å¿ƒç‰¹æ€§,æŒæ¡å®ƒä½ å°±èƒ½å†™å‡ºä¼˜é›…ã€å¯ç»´æŠ¤çš„ä»£ç ! ğŸš€