# Pydantic 数据验证入门指南

## 什么是 Pydantic?

Pydantic 是 Python 中最流行的数据验证和设置管理库。它使用 Python 类型注解来验证数据，确保数据符合预期的结构和类型。FastAPI 正是基于 Pydantic 来处理请求和响应数据的验证。

## 核心概念

Pydantic 的核心是 `BaseModel` 类，通过继承它来定义数据模型。

### 基础示例

```python
from pydantic import BaseModel

class User(BaseModel):
    id: int
    name: str
    email: str
    age: int

# 创建实例 - 自动验证
user = User(id=1, name="张三", email="zhangsan@example.com", age=25)
print(user.name)  # 输出: 张三

# 类型错误会抛出异常
try:
    invalid_user = User(id="abc", name="李四", email="lisi@example.com", age=30)
except Exception as e:
    print(f"验证错误: {e}")
```

## 常用验证功能

### 1. 字段约束

使用 `Field` 可以添加更多验证规则：

```python
from pydantic import BaseModel, Field

class Product(BaseModel):
    name: str = Field(min_length=1, max_length=100)
    price: float = Field(gt=0, description="价格必须大于0")
    quantity: int = Field(ge=0, le=10000)  # ge: >=, le: <=
    description: str | None = Field(None, max_length=500)
```

### 2. 邮箱和 URL 验证

```python
from pydantic import BaseModel, EmailStr, HttpUrl

class ContactInfo(BaseModel):
    email: EmailStr  # 自动验证邮箱格式
    website: HttpUrl  # 自动验证 URL 格式
```

### 3. 正则表达式验证

```python
from pydantic import BaseModel, Field

class Account(BaseModel):
    username: str = Field(pattern=r'^[a-zA-Z0-9_]{3,20}$')
    phone: str = Field(pattern=r'^1[3-9]\d{9}$')  # 中国手机号
```

### 4. 自定义验证器

```python
from pydantic import BaseModel, field_validator

class UserRegistration(BaseModel):
    username: str
    password: str
    confirm_password: str
    
    @field_validator('username')
    @classmethod
    def username_must_be_valid(cls, v):
        if len(v) < 3:
            raise ValueError('用户名至少3个字符')
        return v
    
    @field_validator('confirm_password')
    @classmethod
    def passwords_match(cls, v, info):
        if 'password' in info.data and v != info.data['password']:
            raise ValueError('两次密码不一致')
        return v
```

### 5. 嵌套模型

```python
from pydantic import BaseModel

class Address(BaseModel):
    street: str
    city: str
    country: str

class Person(BaseModel):
    name: str
    age: int
    address: Address  # 嵌套模型

person = Person(
    name="王五",
    age=30,
    address={"street": "中山路123号", "city": "上海", "country": "中国"}
)
```

### 6. 列表和字典验证

```python
from pydantic import BaseModel

class Team(BaseModel):
    name: str
    members: list[str]  # 字符串列表
    scores: dict[str, int]  # 键为字符串，值为整数的字典

team = Team(
    name="开发团队",
    members=["张三", "李四", "王五"],
    scores={"项目A": 95, "项目B": 88}
)
```

## 在 FastAPI 中的应用

```python
from fastapi import FastAPI
from pydantic import BaseModel, Field

app = FastAPI()

class Item(BaseModel):
    name: str = Field(min_length=1, max_length=50)
    price: float = Field(gt=0)
    quantity: int = Field(ge=1)

@app.post("/items/")
async def create_item(item: Item):
    # FastAPI 自动使用 Pydantic 验证请求数据
    return {"item": item, "total": item.price * item.quantity}
```

## 常用验证约束

| 约束         | 说明                             | 示例                      |
| ------------ | -------------------------------- | ------------------------- |
| `gt`         | 大于 (greater than)              | `Field(gt=0)`             |
| `ge`         | 大于等于 (greater than or equal) | `Field(ge=0)`             |
| `lt`         | 小于 (less than)                 | `Field(lt=100)`           |
| `le`         | 小于等于 (less than or equal)    | `Field(le=100)`           |
| `min_length` | 最小长度                         | `Field(min_length=3)`     |
| `max_length` | 最大长度                         | `Field(max_length=50)`    |
| `pattern`    | 正则表达式                       | `Field(pattern=r'^\d+$')` |

## 数据转换

Pydantic 不仅验证数据，还会自动进行类型转换：

```python
from pydantic import BaseModel

class Item(BaseModel):
    id: int
    price: float

# 字符串会自动转换为对应类型
item = Item(id="123", price="99.99")
print(item.id, type(item.id))      # 123 <class 'int'>
print(item.price, type(item.price))  # 99.99 <class 'float'>
```

## 导出数据

```python
user = User(id=1, name="张三", email="zhangsan@example.com", age=25)

# 转为字典
print(user.model_dump())

# 转为 JSON
print(user.model_dump_json())
```

## 总结

Pydantic 的主要优势：

- **类型安全**: 使用 Python 类型注解，IDE 友好
- **自动验证**: 数据自动验证，减少手动检查
- **清晰的错误信息**: 验证失败时提供详细的错误提示
- **高性能**: 底层使用 Rust 实现，速度快
- **与 FastAPI 完美集成**: FastAPI 的核心依赖

通过 Pydantic，你可以确保应用程序处理的数据始终符合预期格式，大大提高代码的健壮性和可维护性。