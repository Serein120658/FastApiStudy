# FastAPI APIRouter å­¦ä¹ ç¬”è®°

## ä¸€ã€ä»€ä¹ˆæ˜¯ APIRouter?

APIRouter æ˜¯ FastAPI æä¾›çš„ä¸€ä¸ªç”¨äºç»„ç»‡å’Œç®¡ç†è·¯ç”±çš„å·¥å…·ã€‚å½“é¡¹ç›®å˜å¤§æ—¶,æŠŠæ‰€æœ‰è·¯ç”±éƒ½å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œä¼šå¾ˆæ··ä¹±,APIRouter å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°†è·¯ç”±åˆ†ç»„ç®¡ç†,è®©ä»£ç æ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤ã€‚

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ APIRouter?

**é—®é¢˜åœºæ™¯:**

```python
# main.py - æ‰€æœ‰è·¯ç”±éƒ½æŒ¤åœ¨ä¸€èµ·,å¾ˆéš¾ç»´æŠ¤
from fastapi import FastAPI

app = FastAPI()

@app.get("/users")
def get_users():
    return {"users": []}

@app.post("/users")
def create_user():
    return {"message": "User created"}

@app.get("/products")
def get_products():
    return {"products": []}

@app.post("/products")
def create_product():
    return {"message": "Product created"}

# ... å‡ åä¸ªè·¯ç”±æ··åœ¨ä¸€èµ·
```

**ä½¿ç”¨ APIRouter çš„ä¼˜åŠ¿:**

- å°†ç›¸å…³çš„è·¯ç”±åˆ†ç»„åˆ°ä¸åŒçš„æ–‡ä»¶ä¸­
- ä»£ç ç»“æ„æ›´æ¸…æ™°,æ˜“äºç»´æŠ¤
- å›¢é˜Ÿåä½œæ›´æ–¹ä¾¿,ä¸åŒäººè´Ÿè´£ä¸åŒæ¨¡å—
- å¯ä»¥ä¸ºä¸€ç»„è·¯ç”±è®¾ç½®ç»Ÿä¸€çš„å‰ç¼€ã€æ ‡ç­¾ç­‰

## äºŒã€åŸºç¡€ç”¨æ³•

### 2.1 åˆ›å»ºç¬¬ä¸€ä¸ª Router

**é¡¹ç›®ç»“æ„:**

```
my_project/
â”œâ”€â”€ main.py
â””â”€â”€ routers/
    â””â”€â”€ users.py
```

**æ­¥éª¤ 1: åˆ›å»º router æ–‡ä»¶ (routers/users.py)**

```python
from fastapi import APIRouter

# åˆ›å»ºä¸€ä¸ª APIRouter å®ä¾‹
router = APIRouter()

@router.get("/users")
def get_users():
    """è·å–æ‰€æœ‰ç”¨æˆ·"""
    return {
        "users": [
            {"id": 1, "name": "å¼ ä¸‰"},
            {"id": 2, "name": "æå››"}
        ]
    }

@router.get("/users/{user_id}")
def get_user(user_id: int):
    """è·å–å•ä¸ªç”¨æˆ·"""
    return {"id": user_id, "name": "å¼ ä¸‰"}

@router.post("/users")
def create_user(name: str):
    """åˆ›å»ºæ–°ç”¨æˆ·"""
    return {"message": f"ç”¨æˆ· {name} åˆ›å»ºæˆåŠŸ"}
```

**æ­¥éª¤ 2: åœ¨ä¸»æ–‡ä»¶ä¸­å¼•å…¥ router (main.py)**

```python
from fastapi import FastAPI
from routers import users

app = FastAPI()

# å°† users router åŒ…å«è¿›æ¥
app.include_router(users.router)

@app.get("/")
def root():
    return {"message": "æ¬¢è¿ä½¿ç”¨ API"}
```

**æµ‹è¯•:**

- è®¿é—® `http://localhost:8000/users` - è·å–æ‰€æœ‰ç”¨æˆ·
- è®¿é—® `http://localhost:8000/users/1` - è·å– ID ä¸º 1 çš„ç”¨æˆ·

### 2.2 æ·»åŠ è·¯ç”±å‰ç¼€

ä½¿ç”¨ `prefix` å‚æ•°å¯ä»¥ä¸ºæ‰€æœ‰è·¯ç”±æ·»åŠ ç»Ÿä¸€å‰ç¼€,é¿å…é‡å¤å†™è·¯å¾„ã€‚

```python
# routers/users.py
from fastapi import APIRouter

router = APIRouter(
    prefix="/users",  # ç»Ÿä¸€å‰ç¼€
    tags=["ç”¨æˆ·ç®¡ç†"]  # åœ¨æ–‡æ¡£ä¸­æ˜¾ç¤ºçš„æ ‡ç­¾
)

# æ³¨æ„:ç°åœ¨è·¯ç”±è·¯å¾„ä¸éœ€è¦å†å†™ /users äº†
@router.get("/")  # å®é™…è·¯å¾„: /users/
def get_users():
    return {"users": ["å¼ ä¸‰", "æå››"]}

@router.get("/{user_id}")  # å®é™…è·¯å¾„: /users/{user_id}
def get_user(user_id: int):
    return {"id": user_id, "name": "å¼ ä¸‰"}

@router.post("/")  # å®é™…è·¯å¾„: /users/
def create_user(name: str):
    return {"message": f"ç”¨æˆ· {name} åˆ›å»ºæˆåŠŸ"}
# main.py
from fastapi import FastAPI
from routers import users

app = FastAPI()

# ç›´æ¥åŒ…å«,ä¸éœ€è¦å†æŒ‡å®šå‰ç¼€
app.include_router(users.router)
```

![image-20251223161138741](04.APIRouter.assets/image-20251223161138741.png)

**<font color=red>å‚è€ƒä¸¤ä¸ªå¼€æºçš„é¡¹ç›®ï¼Œå‘ç°ä»–ä»¬ä½¿ç”¨çš„routeréƒ½æ˜¯ç±»ä¼¼ Java SpringBoot é¡¹ç›®é‚£æ ·æœ‰Controller å±‚  ä¹Ÿå°±æ˜¯åˆ›å»º Controller å°†è·¯ç”±å°è£…åˆ°é‡Œé¢çš„Â </font>**



å‚è€ƒçš„å¼€æºé¡¹ç›®ï¼š

[Banana - sliders](https://github.com/Serein120658/banana-slides) 

[xiaomi-miloco](https://github.com/XiaoMi/xiaomi-miloco.git )

## ä¸‰ã€å®æˆ˜æ¡ˆä¾‹:æ„å»ºä¸€ä¸ªå®Œæ•´çš„åº”ç”¨

### 3.1 é¡¹ç›®ç»“æ„

```
my_shop/
â”œâ”€â”€ main.py
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ users.py
â”‚   â”œâ”€â”€ products.py
â”‚   â””â”€â”€ orders.py
â””â”€â”€ models.py
```

### 3.2 å®šä¹‰æ•°æ®æ¨¡å‹ (models.py)

```python
from pydantic import BaseModel
from typing import Optional

class User(BaseModel):
    id: Optional[int] = None
    name: str
    email: str
    age: int

class Product(BaseModel):
    id: Optional[int] = None
    name: str
    price: float
    stock: int

class Order(BaseModel):
    id: Optional[int] = None
    user_id: int
    product_id: int
    quantity: int
```

### 3.3 ç”¨æˆ·è·¯ç”± (routers/users.py)

```python
from fastapi import APIRouter, HTTPException
from models import User

router = APIRouter(
    prefix="/api/users",
    tags=["ç”¨æˆ·ç®¡ç†"],
)

# æ¨¡æ‹Ÿæ•°æ®åº“
fake_users_db = [
    {"id": 1, "name": "å¼ ä¸‰", "email": "zhang@example.com", "age": 25},
    {"id": 2, "name": "æå››", "email": "li@example.com", "age": 30},
]

@router.get("/", response_model=list[User])
def get_all_users():
    """è·å–æ‰€æœ‰ç”¨æˆ·"""
    return fake_users_db

@router.get("/{user_id}", response_model=User)
def get_user(user_id: int):
    """æ ¹æ® ID è·å–ç”¨æˆ·"""
    for user in fake_users_db:
        if user["id"] == user_id:
            return user
    raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")

@router.post("/", response_model=User)
def create_user(user: User):
    """åˆ›å»ºæ–°ç”¨æˆ·"""
    user.id = len(fake_users_db) + 1
    fake_users_db.append(user.dict())
    return user

@router.put("/{user_id}", response_model=User)
def update_user(user_id: int, user: User):
    """æ›´æ–°ç”¨æˆ·ä¿¡æ¯"""
    for i, u in enumerate(fake_users_db):
        if u["id"] == user_id:
            user.id = user_id
            fake_users_db[i] = user.dict()
            return user
    raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")

@router.delete("/{user_id}")
def delete_user(user_id: int):
    """åˆ é™¤ç”¨æˆ·"""
    for i, u in enumerate(fake_users_db):
        if u["id"] == user_id:
            fake_users_db.pop(i)
            return {"message": "åˆ é™¤æˆåŠŸ"}
    raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")
```

### 3.4 å•†å“è·¯ç”± (routers/products.py)

```python
from fastapi import APIRouter, HTTPException
from models import Product

router = APIRouter(
    prefix="/api/products",
    tags=["å•†å“ç®¡ç†"],
)

fake_products_db = [
    {"id": 1, "name": "iPhone 15", "price": 5999.0, "stock": 50},
    {"id": 2, "name": "MacBook Pro", "price": 12999.0, "stock": 30},
]

@router.get("/", response_model=list[Product])
def get_all_products():
    """è·å–æ‰€æœ‰å•†å“"""
    return fake_products_db

@router.get("/{product_id}", response_model=Product)
def get_product(product_id: int):
    """æ ¹æ® ID è·å–å•†å“"""
    for product in fake_products_db:
        if product["id"] == product_id:
            return product
    raise HTTPException(status_code=404, detail="å•†å“ä¸å­˜åœ¨")

@router.post("/", response_model=Product)
def create_product(product: Product):
    """æ·»åŠ æ–°å•†å“"""
    product.id = len(fake_products_db) + 1
    fake_products_db.append(product.dict())
    return product

@router.patch("/{product_id}/stock")
def update_stock(product_id: int, quantity: int):
    """æ›´æ–°åº“å­˜"""
    for product in fake_products_db:
        if product["id"] == product_id:
            product["stock"] += quantity
            return {"message": "åº“å­˜æ›´æ–°æˆåŠŸ", "new_stock": product["stock"]}
    raise HTTPException(status_code=404, detail="å•†å“ä¸å­˜åœ¨")
```

### 3.5 è®¢å•è·¯ç”± (routers/orders.py)

```python
from fastapi import APIRouter, HTTPException
from models import Order

router = APIRouter(
    prefix="/api/orders",
    tags=["è®¢å•ç®¡ç†"],
)

fake_orders_db = []

@router.get("/", response_model=list[Order])
def get_all_orders():
    """è·å–æ‰€æœ‰è®¢å•"""
    return fake_orders_db

@router.post("/", response_model=Order)
def create_order(order: Order):
    """åˆ›å»ºæ–°è®¢å•"""
    order.id = len(fake_orders_db) + 1
    fake_orders_db.append(order.dict())
    return order

@router.get("/user/{user_id}", response_model=list[Order])
def get_user_orders(user_id: int):
    """è·å–æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰è®¢å•"""
    user_orders = [o for o in fake_orders_db if o["user_id"] == user_id]
    return user_orders
```

### 3.6 ä¸»æ–‡ä»¶ (main.py)

```python
from fastapi import FastAPI
from routers import users, products, orders

app = FastAPI(
    title="æˆ‘çš„å•†åŸ API",
    description="ä¸€ä¸ªä½¿ç”¨ APIRouter æ„å»ºçš„ç¤ºä¾‹åº”ç”¨",
    version="1.0.0"
)

# åŒ…å«æ‰€æœ‰è·¯ç”±
app.include_router(users.router)
app.include_router(products.router)
app.include_router(orders.router)

@app.get("/")
def root():
    return {
        "message": "æ¬¢è¿ä½¿ç”¨å•†åŸ API",
        "docs": "/docs",
        "endpoints": {
            "users": "/api/users",
            "products": "/api/products",
            "orders": "/api/orders"
        }
    }

# è¿è¡Œå‘½ä»¤: uvicorn main:app --reload
```

## å››ã€é«˜çº§ç‰¹æ€§

### 4.1 è·¯ç”±ä¾èµ–æ³¨å…¥

å¯ä»¥ä¸ºæ•´ä¸ª router æ·»åŠ ä¾èµ–,æ‰€æœ‰è·¯ç”±éƒ½ä¼šä½¿ç”¨è¿™ä¸ªä¾èµ–ã€‚

```python
from fastapi import APIRouter, Depends, HTTPException, Header

def verify_token(x_token: str = Header(...)):
    """éªŒè¯ token"""
    if x_token != "secret-token":
        raise HTTPException(status_code=403, detail="æ— æ•ˆçš„ token")
    return x_token

router = APIRouter(
    prefix="/api/admin",
    tags=["ç®¡ç†å‘˜"],
    dependencies=[Depends(verify_token)]  # æ‰€æœ‰è·¯ç”±éƒ½éœ€è¦éªŒè¯
)

@router.get("/dashboard")
def admin_dashboard():
    """åªæœ‰æºå¸¦æ­£ç¡® token æ‰èƒ½è®¿é—®"""
    return {"message": "æ¬¢è¿æ¥åˆ°ç®¡ç†åå°"}
```

### 4.2 è·¯ç”±å“åº”æ¨¡å‹

```python
from fastapi import APIRouter
from pydantic import BaseModel

class UserOut(BaseModel):
    """ä¸åŒ…å«å¯†ç çš„ç”¨æˆ·æ¨¡å‹"""
    id: int
    name: str
    email: str

router = APIRouter()

@router.get("/users/{user_id}", response_model=UserOut)
def get_user(user_id: int):
    # å³ä½¿è¿”å›äº†å¯†ç ,å“åº”ä¸­ä¹Ÿä¸ä¼šåŒ…å«
    return {
        "id": user_id,
        "name": "å¼ ä¸‰",
        "email": "zhang@example.com",
        "password": "secret123"  # è¿™ä¸ªä¸ä¼šå‡ºç°åœ¨å“åº”ä¸­
    }
```

### 4.3 åµŒå¥—è·¯ç”±

å¯ä»¥åœ¨ä¸€ä¸ª router ä¸­åŒ…å«å¦ä¸€ä¸ª routerã€‚

```python
# routers/api.py
from fastapi import APIRouter
from . import users, products

api_router = APIRouter(prefix="/api/v1")

api_router.include_router(users.router)
api_router.include_router(products.router)

# main.py
from fastapi import FastAPI
from routers import api

app = FastAPI()
app.include_router(api.api_router)

# ç°åœ¨è·¯å¾„å˜æˆ: /api/v1/users/, /api/v1/products/
```

## äº”ã€å¸¸è§é—®é¢˜

### Q1: router å’Œ app æœ‰ä»€ä¹ˆåŒºåˆ«?

- `app = FastAPI()` æ˜¯åº”ç”¨çš„ä¸»å…¥å£
- `router = APIRouter()` æ˜¯è·¯ç”±çš„åˆ†ç»„å·¥å…·
- router æœ€ç»ˆéœ€è¦é€šè¿‡ `app.include_router()` åŒ…å«åˆ° app ä¸­

### Q2: ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ prefix?

å½“ä¸€ç»„è·¯ç”±æœ‰å…±åŒçš„å‰ç¼€æ—¶ä½¿ç”¨,æ¯”å¦‚:

- `/api/users/`, `/api/users/{id}` â†’ `prefix="/api/users"`
- `/admin/dashboard`, `/admin/settings` â†’ `prefix="/admin"`

### Q3: tags æœ‰ä»€ä¹ˆç”¨?

tags ä¼šåœ¨è‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£ä¸­å°†è·¯ç”±åˆ†ç»„æ˜¾ç¤º,æ–¹ä¾¿æŸ¥çœ‹å’Œæµ‹è¯•ã€‚

### Q4: å¯ä»¥æœ‰å¤šä¸ª router æ–‡ä»¶å—?

å¯ä»¥!å»ºè®®æŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†,æ¯ä¸ªæ¨¡å—ä¸€ä¸ª router æ–‡ä»¶ã€‚

## å…­ã€å­¦ä¹ å»ºè®®

1. **ä»ç®€å•å¼€å§‹**: å…ˆåˆ›å»ºä¸€ä¸ª router,ç†Ÿæ‚‰åŸºæœ¬ç”¨æ³•
2. **é€æ­¥æ‹†åˆ†**: å½“è·¯ç”±å˜å¤šæ—¶,æŒ‰åŠŸèƒ½æ‹†åˆ†æˆå¤šä¸ªæ–‡ä»¶
3. **ä½¿ç”¨å‰ç¼€**: åˆç†ä½¿ç”¨ prefix é¿å…è·¯å¾„é‡å¤
4. **æ·»åŠ æ–‡æ¡£**: ä¸ºæ¯ä¸ªè·¯ç”±å‡½æ•°å†™æ¸…æ¥šçš„æ–‡æ¡£å­—ç¬¦ä¸²
5. **æŸ¥çœ‹æ–‡æ¡£**: è¿è¡Œåè®¿é—® `/docs` æŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£

## ä¸ƒã€å®Œæ•´è¿è¡Œç¤ºä¾‹

```bash
# å®‰è£… FastAPI
pip install fastapi uvicorn
# è®¿é—®æ–‡æ¡£
æµè§ˆå™¨æ‰“å¼€: http://localhost:8000/docs
```

ç¥å­¦ä¹ æ„‰å¿«!ğŸ‰